name: Update Homebrew

on:
  workflow_dispatch:
    inputs:
      formulas:
        description: 'Formulas to update (comma-separated, e.g., "v,ttm,lazyrdm", or "all")'
        required: false
        default: 'all'
      casks:
        description: 'Casks to update (comma-separated, e.g., "bili-fm", or "all")'
        required: false
        default: 'all'
      dry_run:
        description: 'Dry run (true = only check versions, no changes)'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-homebrew:
    runs-on: macos-latest
    outputs:
      changed: ${{ steps.update.outputs.changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install dependencies
        run: |
          brew tap vst93/tap || true

      - name: Check versions (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=== DRY RUN MODE ==="
          
          # Check formulas
          if [ "${{ github.event.inputs.formulas }}" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "${{ github.event.inputs.formulas }}" | tr ',' ' ')
          fi
          echo "--- Formulas: $FORMULAS ---"
          for formula in $FORMULAS; do
            echo "Formula: $formula"
            brew livecheck --formula $formula || true
          done
          
          # Check casks
          if [ "${{ github.event.inputs.casks }}" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "${{ github.event.inputs.casks }}" | tr ',' ' ')
          fi
          echo ""
          echo "--- Casks: $CASKS ---"
          for cask in $CASKS; do
            echo "Cask: $cask"
            brew livecheck --cask $cask || true
          done

      - name: Update formulas and casks
        id: update
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          FORMULAS: ${{ github.event.inputs.formulas }}
          CASKS: ${{ github.event.inputs.casks }}
        run: |
          echo "=== UPDATING HOMEBREW ==="
          
          # Determine formulas to update
          if [ "$FORMULAS" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "$FORMULAS" | tr ',' ' ')
          fi
          
          # Determine casks to update
          if [ "$CASKS" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "$CASKS" | tr ',' ' ')
          fi
          
          echo "Formulas: $FORMULAS"
          echo "Casks: $CASKS"
          echo ""
          
          # Run formula update script
          if [ -n "$FORMULAS" ]; then
            ruby scripts/update-formula.rb $FORMULAS
          fi
          
          # Run cask update script
          if [ -n "$CASKS" ]; then
            ruby scripts/update-cask.rb $CASKS
          fi
          
          # Check if any files were modified
          if git diff --quiet -- 'Formula/*.rb' 'Casks/*.rb'; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✓ All items are up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ Items have been updated"
          fi

      - name: Audit formulas and casks
        if: ${{ steps.update.outputs.changed == 'true' && github.event.inputs.dry_run != 'true' }}
        env:
          FORMULAS: ${{ github.event.inputs.formulas }}
          CASKS: ${{ github.event.inputs.casks }}
        run: |
          # Determine formulas to audit
          if [ "$FORMULAS" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "$FORMULAS" | tr ',' ' ')
          fi

          # Determine casks to audit
          if [ "$CASKS" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "$CASKS" | tr ',' ' ')
          fi

          # Audit formulas (skip known RuboCop bugs)
          if [ -n "$FORMULAS" ]; then
            echo "--- Auditing Formulas ---"
            brew tap vst93/tap 2>/dev/null || true
            brew audit --formula --except FormulaAudit/Urls,FormulaAudit/PyPiUrls $FORMULAS || true
          fi

          # Audit casks (skip known RuboCop bugs)
          if [ -n "$CASKS" ]; then
            echo ""
            echo "--- Auditing Casks ---"
            brew tap vst93/tap 2>/dev/null || true
            brew audit --cask --except FormulaAudit/Urls,FormulaAudit/PyPiUrls $CASKS || true
          fi

      - name: Show changed files
        if: ${{ steps.update.outputs.changed == 'true' }}
        run: |
          echo "=== CHANGED FILES ==="
          git status

      - name: Create PR and merge
        if: ${{ steps.update.outputs.changed == 'true' && github.event.inputs.dry_run != 'true' }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch and commit changes
          git checkout -b bot/update-homebrew
          git add Formula/ Casks/
          git commit -m "chore: update Homebrew versions" || echo "No changes to commit"

          # Push using token
          git push -u https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }} bot/update-homebrew

          # Create PR
          echo "Creating PR..."
          echo -e "Automated Homebrew formula/cask version update\n\nUpdated:\n- Formulas: v, ttm, lazyrdm\n- Casks: bili-fm\n\nRun \`brew audit --formula --except FormulaAudit/Urls,FormulaAudit/PyPiUrls Formula/*.rb\`\nand \`brew audit --cask --except FormulaAudit/Urls,FormulaAudit/PyPiUrls Casks/*.rb\` to verify." > /tmp/pr_body.txt

          PR_URL=$(gh pr create \
            --title "chore: update Homebrew versions" \
            --body-file /tmp/pr_body.txt \
            --base main \
            --head bot:update-homebrew 2>&1) || PR_URL="PR may already exist"

          echo ""
          echo "$PR_URL"

          # Extract PR number for merging
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$' | tail -1)
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Try to merge the PR using admin privileges
          if [ -n "$PR_NUMBER" ]; then
            echo ""
            echo "Attempting to merge PR #$PR_NUMBER..."
            gh pr merge "$PR_NUMBER" --admin --merge 2>&1 || \
            gh pr merge "$PR_NUMBER" --squash --delete-branch 2>&1 || \
            echo "Merge failed, PR created for manual review"
          else
            echo "Could not extract PR number, skipping auto-merge"
          fi

      - name: Summary
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          if [ "${{ steps.update.outputs.changed }}" == "true" ]; then
            echo "✓ Updates completed"
            echo "✓ PR created and merge attempted"
            echo ""
            echo "Check PR status at: https://github.com/vst93/homebrew-tap/pulls"
          else
            echo "✓ All items are up to date (no changes needed)"
          fi
