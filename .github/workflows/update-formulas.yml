name: Update Homebrew

on:
  workflow_dispatch:
    inputs:
      formulas:
        description: 'Formulas to update (comma-separated, e.g., "v,ttm,lazyrdm", or "all")'
        required: false
        default: 'all'
      casks:
        description: 'Casks to update (comma-separated, e.g., "bili-fm", or "all")'
        required: false
        default: 'all'
      dry_run:
        description: 'Dry run (true = only check versions, no changes)'
        required: false
        default: 'false'

jobs:
  update-homebrew:
    runs-on: macos-latest
    outputs:
      changed: ${{ steps.update.outputs.changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install dependencies
        run: |
          brew tap vst93/tap || true

      - name: Check versions (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=== DRY RUN MODE ==="
          
          # Check formulas
          if [ "${{ github.event.inputs.formulas }}" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "${{ github.event.inputs.formulas }}" | tr ',' ' ')
          fi
          echo "--- Formulas: $FORMULAS ---"
          for formula in $FORMULAS; do
            echo "Formula: $formula"
            brew livecheck --formula $formula || true
          done
          
          # Check casks
          if [ "${{ github.event.inputs.casks }}" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "${{ github.event.inputs.casks }}" | tr ',' ' ')
          fi
          echo ""
          echo "--- Casks: $CASKS ---"
          for cask in $CASKS; do
            echo "Cask: $cask"
            brew livecheck --cask $cask || true
          done

      - name: Update formulas and casks
        id: update
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          FORMULAS: ${{ github.event.inputs.formulas }}
          CASKS: ${{ github.event.inputs.casks }}
        run: |
          echo "=== UPDATING HOMEBREW ==="
          
          # Determine formulas to update
          if [ "$FORMULAS" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "$FORMULAS" | tr ',' ' ')
          fi
          
          # Determine casks to update
          if [ "$CASKS" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "$CASKS" | tr ',' ' ')
          fi
          
          echo "Formulas: $FORMULAS"
          echo "Casks: $CASKS"
          echo ""
          
          # Run formula update script
          if [ -n "$FORMULAS" ]; then
            ruby scripts/update-formula.rb $FORMULAS
          fi
          
          # Run cask update script
          if [ -n "$CASKS" ]; then
            ruby scripts/update-cask.rb $CASKS
          fi
          
          # Check if any files were modified
          if git diff --quiet -- 'Formula/*.rb' 'Casks/*.rb'; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✓ All items are up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ Items have been updated"
          fi

      - name: Audit formulas and casks
        if: ${{ steps.update.outputs.changed == 'true' && github.event.inputs.dry_run != 'true' }}
        env:
          FORMULAS: ${{ github.event.inputs.formulas }}
          CASKS: ${{ github.event.inputs.casks }}
        run: |
          # Determine formulas to audit
          if [ "$FORMULAS" == "all" ]; then
            FORMULAS="v ttm lazyrdm"
          else
            FORMULAS=$(echo "$FORMULAS" | tr ',' ' ')
          fi
          
          # Determine casks to audit
          if [ "$CASKS" == "all" ]; then
            CASKS="bili-fm"
          else
            CASKS=$(echo "$CASKS" | tr ',' ' ')
          fi
          
           # Audit formulas (skip known RuboCop bugs)
           if [ -n "$FORMULAS" ]; then
             echo "--- Auditing Formulas ---"
             brew tap vst93/tap 2>/dev/null || true
             brew audit --formula --except FormulaAudit/Urls,FormulaAudit/PyPiUrls $FORMULAS || true
           fi
           
           # Audit casks (skip known RuboCop bugs)
           if [ -n "$CASKS" ]; then
             echo ""
             echo "--- Auditing Casks ---"
             brew tap vst93/tap 2>/dev/null || true
             brew audit --cask --except FormulaAudit/Urls,FormulaAudit/PyPiUrls $CASKS || true
           fi

      - name: Show changed files
        if: ${{ steps.update.outputs.changed == 'true' }}
        run: |
          echo "=== CHANGED FILES ==="
          git status

      - name: Create Pull Request
        if: ${{ steps.update.outputs.changed == 'true' && github.event.inputs.dry_run != 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot/update-homebrew
          delete-branch: true
          title: 'chore: update Homebrew versions'
          body: |
            Automated Homebrew formula/cask version update
            
            Updated:
            - Formulas: v, ttm, lazyrdm
            - Casks: bili-fm
            
            Run `brew audit --formula --except FormulaAudit/Urls,FormulaAudit/PyPiUrls Formula/*.rb` and `brew audit --cask --except FormulaAudit/Urls,FormulaAudit/PyPiUrls Casks/*.rb` to verify.
          labels: |
            automated
            homebrew

      - name: Summary
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          if [ "${{ steps.update.outputs.changed }}" == "true" ]; then
            echo "✓ Updates completed successfully"
            echo "A PR has been created with the changes."
          else
            echo "✓ All items are up to date (no changes needed)"
          fi
